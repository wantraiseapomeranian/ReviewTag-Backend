<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="pointhistory">

  <select id="sequence" resultType="int">
      SELECT seq_point_history.nextval FROM dual
  </select>

  <insert id="insert">
      INSERT INTO point_history(
          point_history_no, 
          point_history_member_id, 
          point_history_amount, 
          point_history_reason, 
          point_history_item_no
      )
      VALUES(
          seq_point_history.nextval, 
          #{pointHistoryMemberId}, 
          #{pointHistoryAmount}, 
          #{pointHistoryReason},  
          #{pointHistoryItemNo, jdbcType=NUMERIC} 
       )
  </insert>
<insert id="inserthistory">
    INSERT INTO point_history(
        point_history_no,
        point_history_member_id,
        point_history_amount,
        point_history_reason
    )
    VALUES(
        seq_point_history.nextval,
       #{pointHistoryMemberId},
        #{pointHistoryAmount},
        #{pointHistoryReason}
    )
</insert>
  <select id="selectListByMemberId" resultType="PointHistoryDto">
      SELECT 
          point_history_no as pointHistoryNo,
          point_history_member_id as pointHistoryMemberId,
          point_history_item_no as pointHistoryItemNo,
          point_history_amount as pointHistoryAmount,
          point_history_reason as pointHistoryReason,
          point_history_date as pointHistoryDate
      FROM point_history
      WHERE point_history_member_id = #{memberId}
      ORDER BY point_history_no DESC
  </select>
  
  <select id="selectOneNumber" resultType="PointHistoryDto">
      SELECT 
          point_history_no as pointHistoryNo,
          point_history_member_id as pointHistoryMemberId,
          point_history_item_no as pointHistoryItemNo,
          point_history_amount as pointHistoryAmount,
          point_history_reason as pointHistoryReason,
          point_history_date as pointHistoryDate
      FROM point_history
      WHERE point_history_no = #{pointHistoryNo}
  </select>
 
  <delete id="delete">
      DELETE FROM point_history
      WHERE point_history_no = #{pointHistoryNo}
  </delete>
  
  <update id="update">
      UPDATE point_history
      SET
          point_history_reason = #{pointHistoryReason}, 
          point_history_amount = #{pointHistoryAmount},
          point_history_item_no = #{pointHistoryItemNo, jdbcType=NUMERIC}
      WHERE
          point_history_no = #{pointHistoryNo}
  </update>
  


<select id="selectCurrentNickStyle" parameterType="string" resultType="string">
    SELECT point_history_reason 
    FROM (
        SELECT point_history_reason
        FROM point_history
        WHERE point_history_member_id = #{memberId}
          AND point_history_reason LIKE '[착용]%' 
        ORDER BY point_history_no DESC
    )
    WHERE ROWNUM &lt;= 1
</select>

<select id="countHistory" resultType="int">
    SELECT count(*) 
    FROM point_history 
    WHERE point_history_member_id = #{memberId}
    
    <choose>
        <when test="type == 'earn'">
            AND point_history_amount > 0
        </when>
        <when test="type == 'use'">
            AND point_history_amount &lt; 0
        </when>
        <when test="type == 'item'">
            AND point_history_amount = 0
        </when>
    </choose>
</select>

<select id="selectListByMemberIdPaging" resultType="com.kh.finalproject.dto.PointHistoryDto">
    SELECT * FROM (
        SELECT TMP.*, ROWNUM RN FROM (
            SELECT * FROM point_history
            WHERE point_history_member_id = #{memberId}
            
            <choose>
                <when test="type == 'earn'">
                    AND point_history_amount > 0
                </when>
                <when test="type == 'use'">
                    AND point_history_amount &lt; 0
                </when>
                <when test="type == 'item'">
                    AND point_history_amount = 0
                </when>
            </choose>

            ORDER BY point_history_no DESC
        ) TMP
    )
    WHERE RN BETWEEN #{startRow} AND #{endRow}
</select>
  
</mapper>